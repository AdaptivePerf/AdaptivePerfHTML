<!--
    AdaptivePerfHTML: Tool for producing HTML summary of AdaptivePerf results
    Copyright (C) CERN. See LICENSE for details.
-->

<!DOCTYPE html>
<html>
  <head>
    <title>AdaptivePerf results</title>
    <script type="application/javascript"
            src="https://code.jquery.com/jquery-3.7.0.min.js"
	    integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
            crossorigin="anonymous"></script>
    {% for script in scripts %}
    <script type="text/javascript"
            src="{{ url_for('static', filename=script) }}"></script>
    {% endfor %}
    {% for stylesheet in stylesheets %}
    <link type="text/css" rel="stylesheet"
          href="{{ url_for('static', filename=stylesheet) }}" />
    {% endfor %}
    <script type="text/javascript" id="viewer_script"
            data-offcpu-sampling="{{ offcpu_sampling }}"
            data-d3-flamegraph-css="{{ d3_flamegraph_css }}"
            src="{{ url_for('static', filename='viewer.js') }}"></script>
    <style type="text/css">
      html, body {
          height:100%;
      }

      body {
          font-family:Arial;
          background-color:grey;
          display:flex;
          align-items:center;
          justify-content:center;
          height:100%;
          overflow:hidden;
      }

      #block {
          flex-grow:1;
      }

      #main {
          height:90vh;
          width:90vw;
          max-height:90vh;
          max-width:90vw;
          padding:10px;
          border-radius:10px;
          background-color:white;
          display:flex;
          flex-direction:column;
      }

      .scrollable {
          overflow-y:scroll;
      }

      object {
          max-width:100%;
      }

      #header {
          text-align:center;
          margin-bottom:20px;
      }

      #results_combobox {
          font-size:18px;
          min-width:50%;
      }

      #result_background, #please_wait_background {
          display:none;
          position:fixed;
          top: 0;
          left: 0;
          width:100%;
          height:100%;
          background-color: rgba(0, 0, 0, 0.5);
      }

      #callchain {
          font-size:14px;
          overflow:scroll;
          flex-grow:1;
          white-space:nowrap;
      }

      #callchain_block {
          position:fixed;
          border-radius:10px;
          padding:10px;
          background-color:white;
          display:none;
          flex-direction:column;
          max-width:50vw;
      }

      #result_block {
          position:fixed;
          min-height:400px;
          min-width:1050px;
          max-height:90vh;
          max-width:90vw;
          height:70vh;
          width:70vw;
          resize:both;
          overflow:hidden;
          border-radius:10px;
          padding:10px;
          background-color:white;
          top:50%;
          left:50%;
          display:flex;
          flex-direction:column;
          transform:translate(-50%, -50%);
      }

      #please_wait_block {
          position:fixed;
          padding:10px;
          border-radius:10px;
          background-color:white;
          top:50%;
          left:50%;
          transform:translate(-50%, -50%);
          text-align:center;
      }

      #callchain_block {
          box-shadow:3px 3px 10px;
      }

      #callchain {
          /* Based on https://meta.stackexchange.com/q/364048 */
          /* (originally CC BY-SA 4.0, covered by GNU GPL v3 here) */
          font-family:ui-monospace,
                      Cascadia Mono,
                      Segoe UI Mono,
                      Ubuntu Mono,
                      Roboto Mono,
                      Menlo,
                      Monaco,
                      Consolas,
                      monospace;
      }

      #result_title {
          width:100%;
          text-align:center;
          margin-top:10px;
          margin-left:10px;
          margin-right:10px;
          margin-bottom:20px;
      }

      #flamegraph_box {
          overflow:hidden;
          display:flex;
          flex-direction:column;
          flex-grow:1;
      }

      #flamegraph_choice {
          display:flex;
          flex-direction:row;
          width:100%;
          margin-bottom:10px;
      }

      #remainder {
          flex-grow:1;
          display:flex;
          align-items:center;
          margin-right:5px;
      }

      #flamegraph {
          flex-grow:1;
          overflow-x:hidden;
      }

      #metric_choice {
          margin-left:5px;
          margin-right:100px;
          display:flex;
          align-items:center;
      }

      #search {
          flex-grow:1;
          margin-right:5px;
      }

      #download {
          cursor:pointer;
      }

      #metric {
          max-width:250px;
          margin-left:5px;
          margin-right:5px;
      }

      #no_flamegraph {
          display:none;
      }

      #settings {
          display:none;
      }

      #threshold_input, #runtime_diff_threshold_input {
          width:100px;
      }

      #search_results {
          text-align:center;
          font-style:italic;
          margin-bottom:10px;
          display:none;
      }

      #result_box {
          display:flex;
          flex-direction:row;
          flex-grow:1;
      }

      #analysis {
          min-width:200px;
          margin-right:10px;
      }

      #result_parent_area {
          flex-grow:1;
          background-color:grey;
          display:flex;
      }

      #result_area {
          flex-grow:1;
          background-color:grey;
          margin:15px;
          position:relative;
      }

      #flamegraph_window {
          min-width:750px;
          width:750px;
          min-height:200px;
          height:300px;
      }

      .window {
          position:absolute;
          display:flex;
          flex-direction:column;
          border-style:solid;
          border-color:black;
          border-width:2px;
          overflow:hidden;
          resize:both;
          box-shadow:3px 3px 10px;
      }

      .window_header {
          background-color:black;
          color:white;
          padding:5px;
          cursor:grab;
      }

      .window_content {
          overflow:hidden;
          background-color:white;
          flex-grow:1;
          padding:5px;
      }

      .vis-group-level-unknown-but-gte1 {
          border:0;
      }

      .vis-label.vis-nested-group.vis-group-level-unknown-but-gte1 {
          background-color:white;
      }

      .vis-ltr .vis-label.vis-nested-group .vis-inner {
          padding-left:0;
      }

      .narrow_margin {
          margin-top:0;
          margin-bottom:10px;
      }

      .window_title {
          float:left;
          display:flex;
          align-items:center;
          height:100%;
      }

      .window_close {
          float:right;
          display:flex;
          align-items:center;
          cursor:initial;
          height:100%;
      }

      #result_close {
          position:absolute;
          right:5px;
          top:5px;
      }

      #collapse_info {
          font-style:italic;
          text-align:center;
          margin-top:5px;
          margin-bottom:10px;
      }
    </style>
  </head>
  <body onclick="onBackgroundClick()">
    <div id="main">
      <div id="header">
        <h1>AdaptivePerf results</h1>
        <noscript>
          <h2>You must have JavaScript enabled in order to use this page!</h2>
        </noscript>
        <select name="results" id="results_combobox" autocomplete="off">
          <option value="" selected="selected" disabled="disabled">
            Please select a profiling session...
          </option>
          {% for x in ids %}
          <option value="{{ x.value }}">{{ x }}</option>
          {% endfor %}
        </select>
        <span id="settings">
          <p style="font-style:italic">
            <font color="#aa0000">Red parts</font> are on-CPU and
            <font color="#0294e3">blue parts</font> are off-CPU. Right-click
            any thread/process (except the root one) to check its runtime and
            spawning stack trace. Double-click any thread/process to
            open flame graphs.
          </p>
          <p style="font-style:italic">
            Do not display flame graph blocks taking less than
            this % of samples: <input type="number" value="2.50" min="0" max="100"
                                      step=".1" id="threshold_input"
                                      onkeyup="checkValidPercentage(event)"
                                      onfocusout="insertValidPercentage(this)" />
          </p>
          <p style="font-style:italic">
            Warn if the difference between exact and sampled runtime exceeds
            this %: <input type="number" value="50", step="1" min="0"
                           id="runtime_diff_threshold_input"
                           onkeyup="checkValidPercentage(event)"
                           onfocusout="insertValidPercentage(this)" />
          </p>
        </span>
      </div>
      <div id="block" class="scrollable">

      </div>
    </div>
    <div id="callchain_block" onclick="onBlockClick(event)">
      <h3 class="narrow_margin" id="callchain_block_title"></h3>
      <h3 class="narrow_margin">Spawned by:</h3>
      <span id="callchain"></span>
    </div>
    <div id="result_background" onclick="onBackgroundClick()">
      <div id="result_block"
           onmousedown="onFlameGraphBlockMouseDown()"
           onmouseup="onFlameGraphBlockMouseUp()">
        <div id="result_header">
          <!-- This SVG is from Google Material Icons, originally licensed under
               Apache License 2.0: https://www.apache.org/licenses/LICENSE-2.0.txt
               (covered by GNU GPL v3 here) -->
          <svg xmlns="http://www.w3.org/2000/svg" id="result_close"
               height="24px"
               viewBox="0 -960 960 960"
               width="24px" fill="#000000" onclick="onResultCloseClick()">
            <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
          </svg>
          <h2 id="result_title"></h2>
          <p style="text-align: center; color:red" id="sampled_time_warning">
            <b>WARNING:</b> The difference between the exact and sampled
            runtime is <span id="sampled_diff"></span>%, which exceeds
            <span id="runtime_diff_threshold">50</span>%! For accurate results,
            you may need to increase the on-CPU and/or off-CPU sampling
            frequency (depending on whether the process/thread runs mostly
            on- or off-CPU).
          </p>
        </div>
        <div id="result_box">
          <fieldset id="analysis">
            <legend><b>Analysis types</b></legend>
            <input type="checkbox" class="analysis_type" value="flamegraph"
                   id="flamegraph_checkbox"
                   onclick="onAnalysisCheckBoxClick(event)" />
            <label for="flamegraph_checkbox">Flame graphs</label>
          </fieldset>
          <div id="result_parent_area">
            <div id="result_area">
              <div id="flamegraph_window" class="window">
                <div class="window_header" onmousedown="startDrag(event)">
                  <span class="window_title">Flame graphs</span>
                  <span class="window_close">
                    <!-- This SVG is from Google Material Icons, originally licensed under
                         Apache License 2.0: https://www.apache.org/licenses/LICENSE-2.0.txt
                         (covered by GNU GPL v3 here) -->
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px"
                         viewBox="0 -960 960 960"
                         width="24px" fill="#ffffff" onclick="onWindowCloseClick(event)">
                      <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                    </svg>
                </div>
                <div id="flamegraph_box" class="window_content">
                  <span id="collapse_info">
                    Some blocks may be collapsed to speed up rendering, but you can expand
                    them by clicking them.
                  </span>
                  <div id="flamegraph_choice">
                    <div id="metric_choice">
                      Metric:
                      <select name="metric" id="metric" onchange="onMetricChange(event)">

                      </select>
                      <input type="checkbox" id="time_ordered"
                             name="time_ordered" onchange="onTimeOrderedChange(event)">
                      <label for="time_ordered">Time-ordered</label>
                    </div>
                    <div id="remainder">
                      <input type="text" id="search" name="search_query"
                             oninput="onSearchQueryChange(this.value)"
                             placeholder="Search..." />
                      <!-- This SVG is from Google Material Icons, originally licensed under
                           Apache License 2.0: https://www.apache.org/licenses/LICENSE-2.0.txt
                           (covered by GNU GPL v3 here) -->
                      <svg id="download" xmlns="http://www.w3.org/2000/svg" height="24px"
                           viewBox="0 -960 960 960" width="24px" fill="#000000"
                           onclick="downloadFlameGraph()">
                        <title>Download the current flame graph view as PNG</title>
                        <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
                      </svg>
                    </div>
                  </div>
                  <div id="search_results">
                    <b>Search results:</b> <span id="search_blocks"></span> block(s) accounting for
                    <span id="search_found"></span> unit(s) out of
                    <span id="search_total"></span> (<span id="search_percentage"></span>%)
                  </div>
                  <div id="flamegraph" class="scrollable">
                    <p id="no_flamegraph">
                      There is no flame graph associated with the selected process/thread,
                      metric, and time order (or the flame graph could not be loaded)!
                      This may be caused by the inability of capturing a specific event
                      for that process/thread (it is a disadvantage of sampling-based
                      profiling).
                    </p>
                    <div id="svg"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
    <div id="please_wait_background">
      <div id="please_wait_block">
        <h1>Please wait...</h1>
      </div>
    </div>
  </body>
</html>
